{{- if and .Values.persistence.enabled .Values.persistence.modelCache.enabled }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "moondream-server.fullname" . }}-model-download
  labels:
    {{- include "moondream-server.labels" . | nindent 4 }}
    app.kubernetes.io/component: model-download
  annotations: {}
spec:
  template:
    metadata:
      labels:
        {{- include "moondream-server.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: model-download
    spec:
      restartPolicy: OnFailure
      {{- with .Values.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      securityContext:
        {{- toYaml .Values.podSecurityContext | nindent 8 }}
      containers:
        - name: model-downloader
          image: python:3.11-slim
          imagePullPolicy: IfNotPresent
          command:
            - sh
            - -c
            - |
              pip install --no-cache-dir --target /tmp/packages huggingface_hub transformers
              export PYTHONPATH=/tmp/packages:$PYTHONPATH
              python - << 'PY'
              from huggingface_hub import snapshot_download
              import os
              
              cache_dir = '/models'
              os.makedirs(cache_dir, exist_ok=True)
              os.environ['HF_HOME'] = cache_dir
              
              print('Downloading Moondream model...')
              snapshot_download(
                  repo_id="{{ .Values.persistence.modelCache.repoId | default "vikhyatk/moondream2" }}",
                  {{- if ne (.Values.persistence.modelCache.repoId | default "vikhyatk/moondream2") "moondream/moondream3-preview" }}
                  revision="{{ .Values.persistence.modelCache.modelRevision | default "2025-06-21" }}",
                  {{- end }}
                  local_dir=None,
                  local_dir_use_symlinks=False,
                  token=os.environ.get("HF_TOKEN"),
                  ignore_patterns=["*.msgpack"]
              )
              print('Model downloaded successfully!')
              PY
          env:
            - name: HF_HOME
              value: "/models/.cache/huggingface"
            - name: TRANSFORMERS_CACHE
              value: "/models/.cache/huggingface/transformers"
            - name: HF_HUB_CACHE
              value: "/models/.cache/huggingface/hub"
            - name: HF_TOKEN
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.persistence.modelCache.huggingfaceSecretName | default "kubeai-huggingface" }}
                  key: token
          volumeMounts:
            - name: model-cache
              mountPath: /models
      volumes:
        - name: model-cache
          persistentVolumeClaim:
            claimName: {{ .Values.persistence.existingClaim | default (printf "%s-data" (include "moondream-server.fullname" .)) }}
      {{- with .Values.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      affinity:
        nodeAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            preference:
              matchExpressions:
              - key: accelerator
                operator: DoesNotExist
          - weight: 100
            preference:
              matchExpressions:
              - key: nvidia.com/gpu
                operator: DoesNotExist
          - weight: 100
            preference:
              matchExpressions:
              - key: gpu.nvidia.com/class
                operator: DoesNotExist
        {{- with .Values.affinity }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
      {{- with .Values.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
{{- end }}
